<?xml version="1.0" encoding="UTF-8"?>

<launch>
  <!-- Dataset -->
  <arg name="sequence" default="sequence_1" />  <!-- sequence_1, sequence_2 -->
  <arg name="bag_file" default="/media/lukas/T7/Datasets/DOALS/shopville/sequence_1/bag.bag" />
  <arg name="player_rate" default="0.5" /> <!-- 0.3 -->
  
  <!-- Drift Simulation -->
  <arg name="drift_simulation_rollout" default="" /> <!-- Leave empty to ignore drift--> <!-- doals/niederdorf/sequence_1/light_3.csv -->
  
  <!-- Evaluation -->
  <arg name="evaluate" default="true" />
  <arg name="eval_output_path" default="/media/lukas/T7/data/tmp" />
  <arg name="ground_truth_file" default="/media/lukas/T7/Datasets/DOALS/shopville/sequence_1/indices.csv" />
  
  <!-- Motion Detector -->
  <arg name="config_file" default="motion_detector/doals.yaml" />
  <arg name="visualize" default="true" />
  
  
  <!-- Run Nodes -->
  <param name="use_sim_time" value="true" />
  <arg name="use_drift" value="$(eval arg('drift_simulation_rollout')!='')" />

  <!-- Play the bag -->
  <node name="player" pkg="rosbag" type="play" args="--quiet --clock --rate $(arg player_rate) $(arg bag_file) -d 1" /> 
   
  <!-- Lidar Undistortion -->
  <node name="lidar_undistortion" pkg="lidar_undistortion" type="lidar_undistortion_node">
    <remap from="pointcloud" to="/os1_cloud_node/points" />
    <param name="odom_frame_id" value="map" />
    <param name="lidar_frame_id" value="os1_lidar" />
  </node>

  <!-- Drift Simulation -->
  <node name="drift_reader" pkg="drift_simulation" type="drift_reader" output="screen" args="--alsologtostderr" if="$(arg use_drift)">
    <remap from="pointcloud" to="/lidar_undistortion/pointcloud_corrected" />
    <param name="drift_data_file_name" value="$(find drift_simulation)/config/rollouts/$(arg drift_simulation_rollout)" />
  </node>

  <!-- Motion Detection -->
  <node name="motion_detector" pkg="lidar_motion_detection_ros" type="motion_detector" output="screen" args="--alsologtostderr" required="true">
    <remap from="pointcloud" to="/pointcloud_drifted" if="$(arg use_drift)" />
    <remap from="pointcloud" to="/lidar_undistortion/pointcloud_corrected" unless="$(arg use_drift)" />

    <!-- config -->
    <rosparam command="load" file="$(find lidar_motion_detection_ros)/config/$(arg config_file)" />
    
    <!-- evaluation -->
    <param name="evaluation/ground_truth/file_path" value="$(arg ground_truth_file)" />
    <param name="evaluation/output_directory" value="$(arg eval_output_path)" />
    <param name="evaluate" value="$(arg evaluate)" />    
  </node>
  
  <!-- Visualize -->
  <include file="$(find lidar_motion_detection_ros)/launch/visualizer.launch" if="$(arg visualize)"/> 

</launch>
